# راهنمای استقرار کامل

## مرحله 1: آماده‌سازی فایل‌ها روی سرور

### 1.1 فایل‌های مورد نیاز برای انتقال به سرور:

از **VSCode** یا **FileZilla** یا هر ابزار دیگری، این فایل‌ها و پوشه‌ها را به سرور منتقل کنید:

```
/home/isaco/inventory-app/
├── app/                    (کل پوشه)
├── assets/                 (کل پوشه)
├── backend/                (کل پوشه)
├── constants/              (کل پوشه)
├── contexts/               (کل پوشه)
├── lib/                    (کل پوشه)
├── app.json
├── bun.lock
├── package.json
├── tsconfig.json
├── server.ts
├── .env                    (ایجاد کنید)
└── deploy.sh               (فایل جدید)
```

### 1.2 محتوای فایل `.env` روی سرور:

```env
EXPO_PUBLIC_API_URL=http://185.120.251.246:3000
```

## مرحله 2: نصب و بیلد روی سرور

### 2.1 اتصال به سرور:

```bash
ssh isaco@192.168.1.151 -p 2223
```

### 2.2 رفتن به پوشه پروژه:

```bash
cd /home/isaco/inventory-app
```

### 2.3 نصب وابستگی‌ها:

```bash
bun install
```

### 2.4 ساخت نسخه وب:

```bash
chmod +x deploy.sh
./deploy.sh
```

یا به صورت دستی:

```bash
bunx expo export -p web
```

این دستور پوشه `dist` را می‌سازد که شامل فایل‌های استاتیک وب است.

## مرحله 3: اجرای سرور

### 3.1 اجرای سرور به صورت موقت (برای تست):

```bash
bun run server.ts
```

سرور روی پورت 3000 اجرا می‌شود.

### 3.2 اجرای سرور به صورت دائمی (با PM2):

```bash
# نصب PM2
npm install -g pm2

# اجرای سرور
pm2 start server.ts --name inventory-app --interpreter bun

# ذخیره برای اجرای خودکار پس از ریستارت
pm2 save
pm2 startup
```

### 3.3 مدیریت سرور با PM2:

```bash
# مشاهده لاگ‌ها
pm2 logs inventory-app

# مشاهده وضعیت
pm2 status

# ریستارت
pm2 restart inventory-app

# توقف
pm2 stop inventory-app

# حذف
pm2 delete inventory-app
```

## مرحله 4: تست و استفاده

### 4.1 تست سرور:

```bash
curl http://185.120.251.246:3000/health
```

باید پاسخ JSON با `status: "ok"` برگرداند.

### 4.2 دسترسی به اپ:

1. **از مرورگر موبایل:**
   - آدرس: `http://185.120.251.246:3000`

2. **از کامپیوتر در شبکه محلی:**
   - آدرس: `http://192.168.1.151:3000`

## مرحله 5: بروزرسانی اپ

هر بار که تغییری در کد ایجاد می‌کنید:

```bash
# 1. انتقال فایل‌های تغییر یافته به سرور

# 2. بیلد مجدد
cd /home/isaco/inventory-app
bunx expo export -p web

# 3. ریستارت سرور
pm2 restart inventory-app
```

## مسائل رایج و راه حل

### مشکل 1: CORS Error

✅ **حل شده** - تنظیمات CORS در `backend/hono.ts` به درستی پیکربندی شده است.

### مشکل 2: صفحه خالی یا Hello World

این به این دلیل است که فایل‌های استاتیک وب ساخته نشده‌اند. باید:
```bash
bunx expo export -p web
```

### مشکل 3: دیتابیس خالی است

دیتابیس در فایل `inventory.db` در پوشه پروژه ذخیره می‌شود. اگر فایل وجود نداشته باشد، خودکار ساخته می‌شود.

### مشکل 4: پورت در حال استفاده است

بررسی کنید کدام پروسه از پورت 3000 استفاده می‌کند:
```bash
lsof -i :3000
kill -9 <PID>
```

## آدرس‌های مهم

- **اپ موبایل (خارج از شبکه):** `http://185.120.251.246:3000`
- **اپ موبایل (داخل شبکه):** `http://192.168.1.151:3000`
- **API Health Check:** `http://185.120.251.246:3000/health`
- **tRPC Endpoint:** `http://185.120.251.246:3000/api/trpc`

## نکات امنیتی

1. **فایروال:** اطمینان حاصل کنید که پورت 3000 باز است
2. **HTTPS:** برای استفاده در تولید، از یک Reverse Proxy مانند Nginx با SSL استفاده کنید
3. **دیتابیس:** بک‌آپ منظم از `inventory.db` داشته باشید

## ساختار فایل‌های سرور پس از بیلد

```
/home/isaco/inventory-app/
├── dist/                   (فایل‌های استاتیک وب - ساخته شده از expo export)
│   ├── index.html
│   ├── assets/
│   └── ...
├── inventory.db            (دیتابیس - خودکار ساخته می‌شود)
├── backend/
├── server.ts
└── ... (سایر فایل‌ها)
```

